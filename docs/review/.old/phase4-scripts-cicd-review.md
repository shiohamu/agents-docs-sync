# フェーズ4: スクリプトとCI/CDのレビュー手順書

## レビューの目的
スクリプトの品質、CI/CDパイプラインの設定、エラーハンドリング、クロスプラットフォーム対応を評価します。

## 対象ファイル・ディレクトリ

### スクリプトファイル
- `setup.sh` - セットアップスクリプト
- `scripts/run_tests.sh` - テスト実行スクリプト
- `scripts/run_pipeline.sh` - 統合パイプラインスクリプト

### CI/CD設定
- `.github/workflows/ci-cd-pipeline.yml` - GitHub Actionsワークフロー

## レビュー手順

### ステップ1: セットアップスクリプトのレビュー

#### 1.1 setup.shの基本確認
- [ ] シェバンが適切か（`#!/bin/bash`）
- [ ] ファイルが実行可能か（`chmod +x setup.sh`）
- [ ] スクリプトの目的が明確か（コメント、ドキュメント）

#### 1.2 エラーハンドリング
- [ ] `set -e`が使用されているか（エラー時に即座に終了）
- [ ] `set -u`が使用されているか（未定義変数の使用を防止）
- [ ] `set -o pipefail`が使用されているか（パイプラインのエラーを検出）
- [ ] エラーメッセージが明確か
- [ ] 適切な終了コードが返されるか（成功: 0、失敗: 非0）

#### 1.3 依存関係のインストール
- [ ] Pythonのバージョンチェックが適切か
- [ ] 依存関係のインストール手順が正確か
- [ ] インストール方法の選択が適切か（uv, pip, pyproject.toml）
- [ ] インストール失敗時のエラーハンドリングが適切か

#### 1.4 設定ファイルの処理
- [ ] `config.yaml`の自動生成が適切か
- [ ] 既存の`config.yaml`の保護が適切か（上書き防止）
- [ ] `config.yaml.sample`からのコピー処理が適切か

#### 1.5 クロスプラットフォーム対応
- [ ] OSの検出が適切か（Linux, macOS, Windows）
- [ ] プラットフォーム固有の処理が適切か
- [ ] WSL2環境での動作が考慮されているか
- [ ] エラーメッセージがプラットフォーム固有の情報を含むか

#### 1.6 ユーザビリティ
- [ ] 進行状況の表示が適切か（`echo`メッセージ）
- [ ] エラーメッセージが分かりやすいか
- [ ] 成功メッセージが表示されるか

### ステップ2: テスト実行スクリプトのレビュー

#### 2.1 run_tests.shの基本確認
- [ ] シェバンが適切か
- [ ] ファイルが実行可能か
- [ ] スクリプトの目的が明確か

#### 2.2 エラーハンドリング
- [ ] `set -e`が使用されているか
- [ ] テスト失敗時のエラーメッセージが適切か
- [ ] 適切な終了コードが返されるか

#### 2.3 テスト実行
- [ ] pytestの実行コマンドが適切か
- [ ] テストオプションが適切か（`-v`, `--tb=short`など）
- [ ] カバレッジレポートの生成が適切か

#### 2.4 環境設定
- [ ] 必要な環境変数が設定されているか
- [ ] 仮想環境のアクティベートが適切か（必要に応じて）
- [ ] 作業ディレクトリの設定が適切か

### ステップ3: 統合パイプラインスクリプトのレビュー

#### 3.1 run_pipeline.shの基本確認
- [ ] シェバンが適切か
- [ ] ファイルが実行可能か
- [ ] スクリプトの目的が明確か

#### 3.2 エラーハンドリング
- [ ] `set -e`が使用されているか
- [ ] 各ステップの失敗時に適切に終了するか
- [ ] エラーメッセージが明確か

#### 3.3 パイプラインの実行順序
- [ ] ステップの実行順序が適切か（テスト → ドキュメント生成）
- [ ] 各ステップの依存関係が適切か
- [ ] ステップ間のエラーハンドリングが適切か

#### 3.4 進行状況の表示
- [ ] 各ステップの開始・終了が明確に表示されるか
- [ ] エラー時のメッセージが適切か

### ステップ4: GitHub Actionsワークフローのレビュー

#### 4.1 ワークフローの基本設定
- [ ] ワークフローファイルの構文が正しいか（YAML形式）
- [ ] トリガー設定が適切か（`on: push`, `on: pull_request`など）
- [ ] ジョブの定義が適切か

#### 4.2 ジョブの設定
- [ ] 実行環境が適切か（`runs-on: ubuntu-latest`など）
- [ ] ステップの実行順序が適切か
- [ ] 各ステップの目的が明確か（`name:`の使用）

#### 4.3 依存関係のインストール
- [ ] Pythonのバージョン設定が適切か（`actions/setup-python`）
- [ ] 依存関係のインストール手順が適切か
- [ ] キャッシュの使用が適切か（`actions/cache`）

#### 4.4 テスト実行
- [ ] テストの実行コマンドが適切か
- [ ] テスト結果の表示が適切か
- [ ] テスト失敗時の処理が適切か

#### 4.5 ドキュメント生成
- [ ] ドキュメント生成の実行が適切か
- [ ] 生成されたファイルのコミット処理が適切か
- [ ] コミット失敗時のエラーハンドリングが適切か（`|| exit 0`の使用が適切か）

#### 4.6 セキュリティ設定
- [ ] シークレットの使用が適切か（`secrets:`の使用）
- [ ] 権限設定が適切か（`permissions:`の使用）
- [ ] トークンのスコープが最小限か

#### 4.7 通知設定
- [ ] 失敗時の通知が設定されているか（必要に応じて）
- [ ] 成功時の通知が設定されているか（必要に応じて）

### ステップ5: スクリプトの品質確認

#### 5.1 コードスタイル
- [ ] インデントが一貫しているか（タブまたはスペース）
- [ ] 変数の命名規則が一貫しているか（`UPPER_CASE` for constants, `lower_case` for variables）
- [ ] コメントが適切に記載されているか

#### 5.2 関数の使用
- [ ] 繰り返し処理が関数化されているか
- [ ] 関数の責務が明確か
- [ ] 関数の再利用性が高いか

#### 5.3 変数の使用
- [ ] 変数のスコープが適切か
- [ ] グローバル変数の使用が最小限か
- [ ] 変数の引用が適切か（`"$variable"`）

#### 5.4 パスの処理
- [ ] パスの処理が適切か（`$(cd "$(dirname ...)" && pwd)`）
- [ ] 相対パスと絶対パスの使い分けが適切か
- [ ] パストラバーサル対策が適切か

### ステップ6: クロスプラットフォーム対応の確認

#### 6.1 OSの検出
- [ ] OSの検出ロジックが適切か
- [ ] プラットフォーム固有の処理が適切か

#### 6.2 コマンドの互換性
- [ ] 使用しているコマンドがすべてのプラットフォームで利用可能か
- [ ] 代替コマンドの検討がされているか（`which` vs `command -v`）

#### 6.3 パスの処理
- [ ] パス区切り文字の処理が適切か（`/` vs `\`）
- [ ] パスの正規化が適切か

## 確認チェックリスト

### 高優先度
- [ ] すべてのスクリプトに適切なエラーハンドリングがある
- [ ] CI/CDパイプラインが正常に動作する
- [ ] コミット処理のエラーハンドリングが適切か

### 中優先度
- [ ] クロスプラットフォーム対応が適切か
- [ ] スクリプトの可読性と保守性
- [ ] セキュリティ設定が適切か

### 低優先度
- [ ] スクリプトの最適化（実行時間、リソース使用量）
- [ ] 通知機能の充実
- [ ] ログ出力の詳細度

## レビュー結果の記録

### 発見された問題の記録形式
```markdown
#### 問題番号: [問題のタイトル]
- **重要度**: 高/中/低
- **場所**: [ファイルパス:行番号]
- **説明**: [問題の詳細説明]
- **コード例**: [該当コードの抜粋]
- **影響**: [問題が及ぼす影響]
- **推奨対応**: [推奨される修正方法]
```

### 強みの記録形式
```markdown
#### 強み: [強みのタイトル]
- **場所**: [該当箇所]
- **説明**: [なぜ良いのか]
- **コード例**: [該当コードの抜粋]
```

## スクリプトの実行確認方法

### setup.shの実行確認
```bash
# クリーンな環境で実行（仮想環境をクリーンアップ）
./setup.sh
```

### run_tests.shの実行確認
```bash
./scripts/run_tests.sh
```

### run_pipeline.shの実行確認
```bash
./scripts/run_pipeline.sh
```

### GitHub Actionsのローカル実行確認
```bash
# actを使用（オプション）
act -j test
act -j generate-docs
```

## 次のステップ
レビュー完了後、フェーズ5（セキュリティとパフォーマンスのレビュー）に進みます。

