#!/bin/bash
#
# pre-commitフック
# コミット前にドキュメントを自動生成し、変更があればステージングに追加
#

# プロジェクトルートを取得（.git/hooksから実行されるため）
PROJECT_ROOT="$(git rev-parse --show-toplevel 2>/dev/null)"
if [ -z "$PROJECT_ROOT" ]; then
    # Gitリポジトリでない場合はスキップ
    exit 0
fi

DOCGEN_DIR="$PROJECT_ROOT/.docgen"
DOCGEN_SCRIPT="$DOCGEN_DIR/docgen.py"
CONFIG_FILE="$DOCGEN_DIR/config.yaml"

# docgen.pyが存在しない場合はスキップ
if [ ! -f "$DOCGEN_SCRIPT" ]; then
    exit 0
fi

# uvまたはPythonが利用可能か確認
if command -v uv &> /dev/null; then
    PYTHON_CMD="uv run python3"
elif command -v python3 &> /dev/null; then
    PYTHON_CMD="python3"
else
    echo "警告: uvまたはpython3が見つかりません。ドキュメント生成をスキップします。"
    exit 0
fi

# 設定ファイルからパスを取得（デフォルト値を使用）
API_DOC_PATH="docs/api.md"
README_PATH="README.md"

if [ -f "$CONFIG_FILE" ] && command -v python3 &> /dev/null; then
    # Pythonで設定ファイルを読み取り
    API_DOC_PATH=$(python3 -c "
import yaml
import sys
try:
    with open('$CONFIG_FILE', 'r') as f:
        config = yaml.safe_load(f) or {}
    api_path = config.get('output', {}).get('api_doc', 'docs/api.md')
    print(api_path)
except:
    print('docs/api.md')
" 2>/dev/null || echo "docs/api.md")
fi

cd "$PROJECT_ROOT" || exit 0

# ドキュメントを生成
echo "ドキュメントを自動生成中..."
$PYTHON_CMD "$DOCGEN_SCRIPT" 2>&1

# 生成結果を確認
EXIT_CODE=$?
if [ $EXIT_CODE -ne 0 ]; then
    echo "警告: ドキュメント生成中にエラーが発生しました（コード: $EXIT_CODE）"
    # エラーがあってもコミットは続行（警告のみ）
fi

# 変更があったファイルをステージングに追加
CHANGED_FILES=()

# APIドキュメントの変更を確認
if [ -f "$API_DOC_PATH" ]; then
    if ! git diff --quiet "$API_DOC_PATH" 2>/dev/null; then
        git add "$API_DOC_PATH" 2>/dev/null
        CHANGED_FILES+=("$API_DOC_PATH")
    fi
fi

# READMEの変更を確認
if [ -f "$README_PATH" ]; then
    if ! git diff --quiet "$README_PATH" 2>/dev/null; then
        git add "$README_PATH" 2>/dev/null
        CHANGED_FILES+=("$README_PATH")
    fi
fi

# 変更があった場合は通知
if [ "${#CHANGED_FILES[@]}" -gt 0 ]; then
    echo "✓ 以下のドキュメントを更新しました:"
    for file in "${CHANGED_FILES[@]}"; do
        echo "  - $file"
    done
    echo "これらの変更はコミットに含まれます。"
fi

exit 0

